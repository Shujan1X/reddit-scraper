<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overwatch Reddit Scraper - Complete</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 1.1em;
      margin-bottom: 15px;
    }
    
    .badges {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85em;
    }
    
    .content {
      padding: 40px;
    }
    
    .controls {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .filter-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
    }
    
    .filter-section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sort-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .sort-btn {
      padding: 12px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      text-align: center;
    }
    
    .sort-btn:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .sort-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    
    .date-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .input-group label {
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .input-group input, .input-group select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .input-group small {
      color: #666;
      font-size: 0.85em;
    }
    
    .time-filter {
      margin-top: 10px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border: 2px dashed #ffc107;
    }
    
    .time-filter-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    
    .time-btn {
      padding: 8px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s;
    }
    
    .time-btn:hover {
      border-color: #ffc107;
      background: #fff8e1;
    }
    
    .time-btn.active {
      background: #ffc107;
      color: #333;
      border-color: #ffc107;
      font-weight: 600;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      margin-right: 10px;
      margin-top: 10px;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
    }
    
    .status.success {
      background: #e8f5e9;
      color: #388e3c;
      border-left: 4px solid #388e3c;
    }
    
    .status.error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #c62828;
    }
    
    .results {
      margin-top: 30px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-card .number {
      font-size: 2.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-card .label {
      opacity: 0.9;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 1px;
    }
    
    .daily-stats {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .daily-stats h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .daily-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: white;
      margin-bottom: 8px;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }
    
    .daily-date {
      font-weight: 600;
      color: #333;
    }
    
    .daily-count {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .preview {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 10px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .preview h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .post-item, .comment-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .post-item h4 {
      color: #333;
      margin-bottom: 8px;
    }
    
    .post-item .meta, .comment-item .meta {
      color: #666;
      font-size: 0.9em;
    }
    
    .download-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
    
    @media(max-width: 768px) {
      .date-range {
        grid-template-columns: 1fr;
      }
      .sort-options {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéÆ Overwatch Reddit Scraper</h1>
      <p>Complete scraper with sorting, date filtering, and statistics!</p>
      <div class="badges">
        <span class="badge">üî• Hot</span>
        <span class="badge">‚≠ê Top</span>
        <span class="badge">üÜï New</span>
        <span class="badge">üìà Rising</span>
        <span class="badge">üëç Best</span>
        <span class="badge">üìÖ Date Filter</span>
      </div>
    </div>
    
    <div class="content">
      <div class="controls">
        <div class="input-group">
          <label for="workerUrl">üîó Cloudflare Worker URL:</label>
          <input 
            type="text" 
            id="workerUrl" 
            placeholder="https://reddit-scraper.YOUR-NAME.workers.dev"
            value=""
          >
          <small>Deploy worker-complete.js to your Cloudflare account</small>
        </div>
        
        <div class="input-group">
          <label for="subreddit">üì± Subreddit:</label>
          <select id="subreddit">
            <option value="Overwatch">r/Overwatch</option>
            <option value="Competitiveoverwatch">r/Competitiveoverwatch</option>
            <option value="OverwatchUniversity">r/OverwatchUniversity</option>
            <option value="Overwatch2">r/Overwatch2</option>
          </select>
        </div>
        
        <!-- Sort Filter Section -->
        <div class="filter-section">
          <h3>üîç Sort By:</h3>
          <div class="sort-options">
            <div class="sort-btn" data-sort="hot" onclick="selectSort('hot')">
              üî• Hot
            </div>
            <div class="sort-btn active" data-sort="new" onclick="selectSort('new')">
              üÜï New
            </div>
            <div class="sort-btn" data-sort="top" onclick="selectSort('top')">
              ‚≠ê Top
            </div>
            <div class="sort-btn" data-sort="rising" onclick="selectSort('rising')">
              üìà Rising
            </div>
            <div class="sort-btn" data-sort="best" onclick="selectSort('best')">
              üëç Best
            </div>
          </div>
          
          <!-- Time Filter (only for Top) -->
          <div id="timeFilterSection" class="time-filter hidden">
            <label style="font-weight: 600; color: #333; margin-bottom: 5px; display: block;">
              ‚è∞ Top posts from:
            </label>
            <div class="time-filter-options">
              <div class="time-btn" data-time="hour" onclick="selectTime('hour')">Hour</div>
              <div class="time-btn" data-time="day" onclick="selectTime('day')">Day</div>
              <div class="time-btn" data-time="week" onclick="selectTime('week')">Week</div>
              <div class="time-btn" data-time="month" onclick="selectTime('month')">Month</div>
              <div class="time-btn" data-time="year" onclick="selectTime('year')">Year</div>
              <div class="time-btn active" data-time="all" onclick="selectTime('all')">All Time</div>
            </div>
          </div>
        </div>
        
        <!-- Date Range Section -->
        <div class="filter-section">
          <h3>üìÖ Date Range (Optional):</h3>
          <div class="date-range">
            <div class="input-group">
              <label for="startDate">Start Date:</label>
              <input type="date" id="startDate">
              <small>Leave blank for no limit</small>
            </div>
            
            <div class="input-group">
              <label for="endDate">End Date:</label>
              <input type="date" id="endDate">
              <small>Leave blank for no limit</small>
            </div>
          </div>
        </div>
        
        <div class="input-group">
          <label for="numPosts">üìä Number of Posts:</label>
          <input type="number" id="numPosts" value="25" min="1" max="100">
          <small>Maximum: 100 posts</small>
        </div>
        
        <div class="input-group">
          <label for="commentsPerPost">üí¨ Comments per Post:</label>
          <input type="number" id="commentsPerPost" value="20" min="1" max="50">
        </div>
        
        <button class="btn btn-primary" onclick="startScraping()" id="scrapeBtn">
          üöÄ Start Scraping
        </button>
      </div>
      
      <div id="status" class="status"></div>
      <div id="loading" class="hidden">
        <div class="spinner"></div>
        <p style="text-align: center; color: #666;">Scraping data... This may take a minute...</p>
      </div>
      
      <div id="results" class="results hidden">
        <div class="stats">
          <div class="stat-card">
            <div class="number" id="postsCount">0</div>
            <div class="label">Posts</div>
          </div>
          <div class="stat-card">
            <div class="number" id="commentsCount">0</div>
            <div class="label">Comments</div>
          </div>
          <div class="stat-card">
            <div class="number" id="daysCount">0</div>
            <div class="label">Days</div>
          </div>
          <div class="stat-card">
            <div class="number" id="sortType">-</div>
            <div class="label">Sort Type</div>
          </div>
        </div>
        
        <div class="daily-stats" id="dailyStatsSection">
          <h3>üìä Posts per Day</h3>
          <div id="dailyStatsContent"></div>
        </div>
        
        <div class="download-section">
          <h3>üì• Download Data</h3>
          <button class="btn btn-success" onclick="downloadPostsCSV()">Download Posts CSV</button>
          <button class="btn btn-success" onclick="downloadCommentsCSV()">Download Comments CSV</button>
          <!-- <button class="btn btn-success" onclick="downloadDailyStatsCSV()">Download Daily Stats CSV</button> -->
        </div>
        
        <div class="preview">
          <h3>Preview - Posts</h3>
          <div id="postsPreview"></div>
        </div>
        
        <div class="preview">
          <h3>Preview - Comments</h3>
          <div id="commentsPreview"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let scrapedData = null;
    let selectedSort = 'new';
    let selectedTime = 'all';
    
    function selectSort(sortType) {
      selectedSort = sortType;
      
      // Update UI
      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-sort="${sortType}"]`).classList.add('active');
      
      // Show/hide time filter for 'top'
      const timeFilterSection = document.getElementById('timeFilterSection');
      if (sortType === 'top') {
        timeFilterSection.classList.remove('hidden');
      } else {
        timeFilterSection.classList.add('hidden');
      }
    }
    
    function selectTime(timeType) {
      selectedTime = timeType;
      
      // Update UI
      document.querySelectorAll('.time-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-time="${timeType}"]`).classList.add('active');
    }
    
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
    }
    
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }
    
    async function startScraping() {
      const workerUrl = document.getElementById('workerUrl').value.trim();
      const subreddit = document.getElementById('subreddit').value;
      const numPosts = parseInt(document.getElementById('numPosts').value);
      const commentsPerPost = parseInt(document.getElementById('commentsPerPost').value);
      const startDate = document.getElementById('startDate').value || null;
      const endDate = document.getElementById('endDate').value || null;
      
      if (!workerUrl) {
        showStatus('‚ùå Please enter your Cloudflare Worker URL!', 'error');
        return;
      }
      
      if (!workerUrl.startsWith('http')) {
        showStatus('‚ùå Worker URL must start with https://', 'error');
        return;
      }
      
      // Disable button and show loading
      document.getElementById('scrapeBtn').disabled = true;
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('results').classList.add('hidden');
      hideStatus();
      
      try {
        let statusMsg = `üîç Scraping ${selectedSort} posts from r/${subreddit}`;
        if (selectedSort === 'top') {
          statusMsg += ` (${selectedTime})`;
        }
        if (startDate || endDate) {
          statusMsg += ` | Dates: ${startDate || 'any'} to ${endDate || 'now'}`;
        }
        showStatus(statusMsg + '...', 'info');
        
        const response = await fetch(`${workerUrl}/scrape`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subreddit,
            limit: numPosts,
            commentsPerPost,
            startDate,
            endDate,
            sortBy: selectedSort,
            timeFilter: selectedTime
          })
        });
        
        if (!response.ok) {
          throw new Error(`Worker responded with status ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Worker is not returning JSON. Make sure you deployed worker-complete.js');
        }
        
        scrapedData = await response.json();
        
        if (scrapedData.error) {
          throw new Error(scrapedData.error);
        }
        
        // Display results
        displayResults(scrapedData);
        
        showStatus(`‚úÖ Successfully scraped ${scrapedData.posts.length} posts and ${scrapedData.comments.length} comments!`, 'success');
        
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
        console.error('Scraping error:', error);
      } finally {
        document.getElementById('scrapeBtn').disabled = false;
        document.getElementById('loading').classList.add('hidden');
      }
    }
    
    function displayResults(data) {
      // Update stats
      document.getElementById('postsCount').textContent = data.posts.length;
      document.getElementById('commentsCount').textContent = data.comments.length;
      
      // Sort type
      let sortDisplay = data.stats.sortBy.toUpperCase();
      if (data.stats.sortBy === 'top') {
        sortDisplay += ` (${data.stats.timeFilter})`;
      }
      document.getElementById('sortType').textContent = sortDisplay;
      
      // Display daily stats
      const dailyStats = data.dailyStats || {};
      const dates = Object.keys(dailyStats).sort();
      document.getElementById('daysCount').textContent = dates.length;
      
      const dailyStatsContent = document.getElementById('dailyStatsContent');
      if (dates.length > 0) {
        dailyStatsContent.innerHTML = dates.map(date => `
          <div class="daily-item">
            <span class="daily-date">${date}</span>
            <span class="daily-count">${dailyStats[date]} posts</span>
          </div>
        `).join('');
      } else {
        dailyStatsContent.innerHTML = '<p style="color: #666;">No date-specific data available</p>';
      }
      
      // Display posts preview
      const postsPreview = document.getElementById('postsPreview');
      postsPreview.innerHTML = data.posts.slice(0, 5).map(post => `
        <div class="post-item">
          <h4><a href="${post.url}" target="_blank">${escapeHtml(post.title)}</a></h4>
          <div class="meta">
            üë§ ${escapeHtml(post.author)} | 
            ‚¨ÜÔ∏è ${post.score} | 
            üí¨ ${post.num_comments} comments | 
            üèÜ ${post.awards || 0} awards | 
            üìÖ ${new Date(post.created_utc).toLocaleString()}
          </div>
        </div>
      `).join('');
      
      // Display comments preview
      const commentsPreview = document.getElementById('commentsPreview');
      commentsPreview.innerHTML = data.comments.slice(0, 5).map(comment => `
        <div class="comment-item">
          <div class="meta" style="margin-bottom: 8px;">
            üë§ ${escapeHtml(comment.author)} | 
            ‚¨ÜÔ∏è ${comment.score} | 
            üèÜ ${comment.awards || 0} awards | 
            üìÖ ${new Date(comment.created_utc).toLocaleString()}
          </div>
          <div>${escapeHtml(comment.text.substring(0, 200))}${comment.text.length > 200 ? '...' : ''}</div>
          <div class="meta" style="margin-top: 8px;">
            Post: ${escapeHtml(comment.post_title.substring(0, 60))}${comment.post_title.length > 60 ? '...' : ''}
          </div>
        </div>
      `).join('');
      
      // Show results section
      document.getElementById('results').classList.remove('hidden');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function downloadPostsCSV() {
      if (!scrapedData) return;
      const csv = convertPostsToCSV(scrapedData.posts);
      downloadFile(csv, `overwatch_posts_${selectedSort}_${Date.now()}.csv`, 'text/csv');
    }
    
    function downloadCommentsCSV() {
      if (!scrapedData) return;
      const csv = convertCommentsToCSV(scrapedData.comments);
      downloadFile(csv, `overwatch_comments_${selectedSort}_${Date.now()}.csv`, 'text/csv');
    }
    
    function downloadDailyStatsCSV() {
      if (!scrapedData || !scrapedData.dailyStats) return;
      
      let csv = 'Date,Post Count\n';
      const dates = Object.keys(scrapedData.dailyStats).sort();
      
      dates.forEach(date => {
        csv += `${date},${scrapedData.dailyStats[date]}\n`;
      });
      
      downloadFile(csv, `daily_stats_${selectedSort}_${Date.now()}.csv`, 'text/csv');
    }
    
    function convertPostsToCSV(posts) {
      const headers = ['id', 'title', 'author', 'score', 'upvote_ratio', 'num_comments', 'awards', 'created_utc', 'url', 'permalink', 'selftext', 'is_self', 'flair', 'domain'];
      
      let csv = headers.join(',') + '\n';
      
      posts.forEach(post => {
        const row = headers.map(header => {
          const value = post[header] || '';
          const escaped = String(value).replace(/"/g, '""');
          return `"${escaped}"`;
        });
        csv += row.join(',') + '\n';
      });
      
      return csv;
    }
    
    function convertCommentsToCSV(comments) {
      const headers = ['id', 'post_title', 'post_url', 'post_id', 'post_date', 'author', 'text', 'score', 'awards', 'created_utc', 'depth', 'parent_id', 'is_submitter'];
      
      let csv = headers.join(',') + '\n';
      
      comments.forEach(comment => {
        const row = headers.map(header => {
          const value = comment[header] || '';
          const escaped = String(value).replace(/"/g, '""');
          return `"${escaped}"`;
        });
        csv += row.join(',') + '\n';
      });
      
      return csv;
    }
    
    function downloadFile(content, filename, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
