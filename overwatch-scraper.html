<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overwatch Reddit Scraper</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }
    
    .content {
      padding: 40px;
    }
    
    .alert {
      padding: 20px;
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    
    .alert h3 {
      color: #856404;
      margin-bottom: 10px;
    }
    
    .alert ol {
      color: #856404;
      margin-left: 20px;
    }
    
    .alert li {
      margin: 5px 0;
    }
    
    .controls {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .input-group label {
      font-weight: 600;
      color: #333;
    }
    
    .input-group input, .input-group select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .input-group input.error {
      border-color: #f44336;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      margin-right: 10px;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(56, 239, 125, 0.4);
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
    }
    
    .status.success {
      background: #e8f5e9;
      color: #388e3c;
      border-left: 4px solid #388e3c;
    }
    
    .status.error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #c62828;
    }
    
    .results {
      margin-top: 30px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-card .number {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-card .label {
      opacity: 0.9;
      text-transform: uppercase;
      font-size: 0.9em;
      letter-spacing: 1px;
    }
    
    .preview {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .preview h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .post-item, .comment-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .post-item h4 {
      color: #333;
      margin-bottom: 8px;
    }
    
    .post-item .meta, .comment-item .meta {
      color: #666;
      font-size: 0.9em;
    }
    
    .download-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéÆ Overwatch Reddit Scraper</h1>
      <p>Scrape posts and comments from r/Overwatch without API keys!</p>
    </div>
    
    <div class="content">
      <div class="alert">
        <h3>‚ö†Ô∏è Setup Required!</h3>
        <p><strong>Before using this scraper, you must:</strong></p>
        <ol>
          <li>Deploy the Cloudflare Worker using <code>worker-simple.js</code></li>
          <li>Copy your worker URL (looks like: https://your-worker.workers.dev)</li>
          <li>Paste it in the field below</li>
        </ol>
        <p style="margin-top: 10px;"><strong>Don't have a worker URL yet?</strong> Follow the <code>DEPLOYMENT_GUIDE.md</code> file!</p>
      </div>
      
      <div class="controls">
        <div class="input-group">
          <label for="workerUrl">üîó Cloudflare Worker URL: *</label>
          <input 
            type="text" 
            id="workerUrl" 
            placeholder="https://reddit-scraper.YOUR-NAME.workers.dev"
            value=""
          >
          <small style="color: #666;">Example: https://reddit-scraper.john123.workers.dev</small>
        </div>
        
        <div class="input-group">
          <label for="subreddit">üì± Subreddit:</label>
          <select id="subreddit">
            <option value="Overwatch">r/Overwatch</option>
            <option value="Competitiveoverwatch">r/Competitiveoverwatch</option>
            <option value="OverwatchUniversity">r/OverwatchUniversity</option>
            <option value="Overwatch2">r/Overwatch2</option>
          </select>
        </div>
        
        <div class="input-group">
          <label for="numPosts">üìä Number of Posts:</label>
          <input type="number" id="numPosts" value="5" min="1" max="25">
        </div>
        
        <div class="input-group">
          <label for="commentsPerPost">üí¨ Comments per Post:</label>
          <input type="number" id="commentsPerPost" value="15" min="1" max="30">
        </div>
        
        <button class="btn btn-primary" onclick="startScraping()" id="scrapeBtn">
          üöÄ Start Scraping
        </button>
      </div>
      
      <div id="status" class="status"></div>
      <div id="loading" class="hidden">
        <div class="spinner"></div>
        <p style="text-align: center; color: #666;">Scraping data... This may take a minute...</p>
      </div>
      
      <div id="results" class="results hidden">
        <div class="stats">
          <div class="stat-card">
            <div class="number" id="postsCount">0</div>
            <div class="label">Posts</div>
          </div>
          <div class="stat-card">
            <div class="number" id="commentsCount">0</div>
            <div class="label">Comments</div>
          </div>
        </div>
        
        <div class="download-section">
          <h3>üì• Download Data</h3>
          <button class="btn btn-success" onclick="downloadPostsCSV()">Download Posts CSV</button>
          <button class="btn btn-success" onclick="downloadCommentsCSV()">Download Comments CSV</button>
        </div>
        
        <div class="preview">
          <h3>Preview - Recent Posts</h3>
          <div id="postsPreview"></div>
        </div>
        
        <div class="preview" style="margin-top: 20px;">
          <h3>Preview - Recent Comments</h3>
          <div id="commentsPreview"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let scrapedData = null;
    
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
    }
    
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }
    
    async function startScraping() {
      const workerUrlInput = document.getElementById('workerUrl');
      const workerUrl = workerUrlInput.value.trim();
      const subreddit = document.getElementById('subreddit').value;
      const numPosts = parseInt(document.getElementById('numPosts').value);
      const commentsPerPost = parseInt(document.getElementById('commentsPerPost').value);
      
      // Validate worker URL
      if (!workerUrl) {
        showStatus('‚ùå Please enter your Cloudflare Worker URL!', 'error');
        workerUrlInput.classList.add('error');
        workerUrlInput.focus();
        return;
      }
      
      if (!workerUrl.startsWith('http://') && !workerUrl.startsWith('https://')) {
        showStatus('‚ùå Worker URL must start with https:// or http://', 'error');
        workerUrlInput.classList.add('error');
        workerUrlInput.focus();
        return;
      }
      
      if (!workerUrl.includes('workers.dev') && !workerUrl.includes('localhost')) {
        showStatus('‚ö†Ô∏è Warning: URL doesn\'t look like a Cloudflare Worker URL. It should contain "workers.dev"', 'error');
        workerUrlInput.classList.add('error');
        return;
      }
      
      workerUrlInput.classList.remove('error');
      
      // Disable button and show loading
      document.getElementById('scrapeBtn').disabled = true;
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('results').classList.add('hidden');
      hideStatus();
      
      try {
        showStatus('üîç Connecting to worker...', 'info');
        
        const response = await fetch(`${workerUrl}/scrape`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subreddit,
            limit: numPosts,
            commentsPerPost
          })
        });
        
        if (!response.ok) {
          throw new Error(`Worker responded with status ${response.status}. Make sure your worker is deployed correctly.`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Worker is not returning JSON. Make sure you deployed worker-simple.js correctly and the URL ends with /scrape');
        }
        
        showStatus('üì• Downloading data from Reddit...', 'info');
        scrapedData = await response.json();
        
        if (scrapedData.error) {
          throw new Error(scrapedData.error);
        }
        
        // Display results
        displayResults(scrapedData);
        
        showStatus(`‚úÖ Successfully scraped ${scrapedData.posts.length} posts and ${scrapedData.comments.length} comments!`, 'success');
        
      } catch (error) {
        let errorMessage = error.message;
        
        // Provide helpful error messages
        if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError')) {
          errorMessage = '‚ùå Cannot connect to worker. Check:\n1. Worker URL is correct\n2. Worker is deployed\n3. URL ends with /scrape\n4. Your internet connection is working';
        } else if (errorMessage.includes('not valid JSON')) {
          errorMessage = '‚ùå Worker is not returning data correctly. Make sure:\n1. You deployed worker-simple.js (not the old version)\n2. The code was copied completely\n3. You clicked "Save and Deploy"';
        }
        
        showStatus(errorMessage, 'error');
        console.error('Scraping error:', error);
      } finally {
        document.getElementById('scrapeBtn').disabled = false;
        document.getElementById('loading').classList.add('hidden');
      }
    }
    
    function displayResults(data) {
      // Update stats
      document.getElementById('postsCount').textContent = data.posts.length;
      document.getElementById('commentsCount').textContent = data.comments.length;
      
      // Display posts preview
      const postsPreview = document.getElementById('postsPreview');
      postsPreview.innerHTML = data.posts.slice(0, 5).map(post => `
        <div class="post-item">
          <h4><a href="${post.url}" target="_blank">${escapeHtml(post.title)}</a></h4>
          <div class="meta">
            üë§ ${escapeHtml(post.author)} | 
            ‚¨ÜÔ∏è ${post.score} | 
            üí¨ ${post.num_comments} comments | 
            üìÖ ${new Date(post.created_utc).toLocaleString()}
          </div>
        </div>
      `).join('');
      
      // Display comments preview
      const commentsPreview = document.getElementById('commentsPreview');
      commentsPreview.innerHTML = data.comments.slice(0, 5).map(comment => `
        <div class="comment-item">
          <div class="meta" style="margin-bottom: 8px;">
            üë§ ${escapeHtml(comment.author)} | 
            ‚¨ÜÔ∏è ${comment.score} | 
            üìÖ ${new Date(comment.created_utc).toLocaleString()}
          </div>
          <div>${escapeHtml(comment.text.substring(0, 200))}${comment.text.length > 200 ? '...' : ''}</div>
          <div class="meta" style="margin-top: 8px;">
            Post: ${escapeHtml(comment.post_title)}
          </div>
        </div>
      `).join('');
      
      // Show results section
      document.getElementById('results').classList.remove('hidden');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function downloadPostsCSV() {
      if (!scrapedData) return;
      
      const csv = convertPostsToCSV(scrapedData.posts);
      downloadFile(csv, `overwatch_posts_${Date.now()}.csv`, 'text/csv');
    }
    
    async function downloadCommentsCSV() {
      if (!scrapedData) return;
      
      const csv = convertCommentsToCSV(scrapedData.comments);
      downloadFile(csv, `overwatch_comments_${Date.now()}.csv`, 'text/csv');
    }
    
    function convertPostsToCSV(posts) {
      const headers = ['id', 'title', 'author', 'score', 'upvote_ratio', 'num_comments', 'created_utc', 'url', 'permalink', 'selftext', 'is_self', 'flair', 'domain'];
      
      let csv = headers.join(',') + '\n';
      
      posts.forEach(post => {
        const row = headers.map(header => {
          const value = post[header] || '';
          const escaped = String(value).replace(/"/g, '""');
          return `"${escaped}"`;
        });
        csv += row.join(',') + '\n';
      });
      
      return csv;
    }
    
    function convertCommentsToCSV(comments) {
      const headers = ['id', 'post_title', 'post_url', 'post_id', 'author', 'text', 'score', 'created_utc', 'depth', 'parent_id', 'is_submitter'];
      
      let csv = headers.join(',') + '\n';
      
      comments.forEach(comment => {
        const row = headers.map(header => {
          const value = comment[header] || '';
          const escaped = String(value).replace(/"/g, '""');
          return `"${escaped}"`;
        });
        csv += row.join(',') + '\n';
      });
      
      return csv;
    }
    
    function downloadFile(content, filename, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
